# План 0013: Исправление ошибки ERR_HTTP2_PROTOCOL_ERROR в SSE стриминге

**Дата создания:** 2025-11-01  
**Статус:** План готов к выполнению  
**Приоритет:** Высокий

## Проблема

При стриминге длинных ответов (>1000 токенов) через `/api/chat/stream` возникает ошибка `ERR_HTTP2_PROTOCOL_ERROR` при статусе 200 OK. Ошибка возникает только при длинных ответах, что указывает на проблему с таймаутами прокси/CDN (Amvera) при длительном отсутствии активности в SSE потоке.

**Ошибка в консоли браузера:**
```
POST https://ai-chat-sigma-y31415.amvera.io/api/chat/stream net::ERR_HTTP2_PROTOCOL_ERROR 200 (OK)
Ошибка чтения потока данных: network error
```

## Причина

Прокси/CDN (Amvera) разрывает HTTP/2 соединение при отсутствии активности более 5-10 секунд. При длинных ответах от OpenRouter могут быть паузы между токенами, что приводит к таймауту соединения.

## Решение

### 1. Добавление keep-alive комментариев (КРИТИЧНО)

**Задача:** Отправлять пустые SSE комментарии (`:\n\n`) каждые 8 секунд при отсутствии данных от OpenRouter для поддержания соединения активным.

**Реализация:**
- Отслеживать время последнего отправленного события
- При отсутствии данных от OpenRouter более 8 секунд отправлять keep-alive комментарий
- Keep-alive должен отправляться даже если генератор ожидает данные от OpenRouter

**Файл:** `app/api/routes.py`, функция `generate()` (строки 373-527)

### 2. Улучшение парсинга SSE потока

**Задача:** Правильно обрабатывать все типы SSE строк от OpenRouter.

**Реализация:**
- Корректно обрабатывать комментарии (строки начинающиеся с `:`)
- Правильно обрабатывать пустые строки
- Корректно обрабатывать data строки (формат `data: {...}`)
- Правильно обрабатывать маркер `[DONE]`
- Улучшить декодирование UTF-8 с обработкой ошибок
- Гарантировать правильный формат SSE событий (`data: {...}\n\n`)

**Файл:** `app/api/routes.py`, функция `generate()` (строки 407-490)

### 3. Улучшение обработки ошибок

**Задача:** Не прерывать генератор при незначительных ошибках парсинга.

**Реализация:**
- Игнорировать некорректные JSON строки (продолжать работу)
- Правильно закрывать соединение только при критических ошибках
- Добавить логирование для отладки

**Файл:** `app/api/routes.py`, функция `generate()` (строки 488-527)

### 4. Настройка Gunicorn для streaming

**Задача:** Настроить Gunicorn для корректной работы с длинными streaming запросами.

**Реализация:**
- Добавить `--timeout 120` для длинных запросов
- Добавить `--worker-class sync` для корректной работы streaming
- Убедиться что worker поддерживает длительные соединения

**Файл:** `amvera.yaml` (строка 11)

### 5. Улучшение заголовков ответа

**Задача:** Убедиться что заголовки корректно настроены для SSE streaming.

**Реализация:**
- Добавить `Connection: keep-alive`
- Проверить что `X-Accel-Buffering: no` установлен правильно
- Убедиться что `Cache-Control: no-cache` присутствует

**Файл:** `app/api/routes.py`, функция `chat_stream()` (строки 530-537)

## Файлы для изменения

1. **`app/api/routes.py`**
   - Функция `chat_stream()` - улучшить заголовки ответа
   - Функция `generate()` - добавить keep-alive, улучшить парсинг SSE, исправить обработку ошибок

2. **`amvera.yaml`**
   - Команда запуска Gunicorn - добавить параметры для streaming

## Детали реализации

### Keep-alive механизм

```python
import time
import threading

# В функции generate():
last_event_time = time.time()
keep_alive_interval = 8  # секунд

# При отправке каждого события:
last_event_time = time.time()

# В цикле чтения потока:
current_time = time.time()
if current_time - last_event_time > keep_alive_interval:
    yield ":\n\n"  # Keep-alive комментарий
    last_event_time = current_time
```

### Улучшенный парсинг SSE

```python
for line in response.iter_lines():
    if not line:
        continue
    
    line_str = line.decode('utf-8', errors='ignore')
    
    # Комментарии (keep-alive от OpenRouter)
    if line_str.startswith(':'):
        continue
    
    # Data строки
    if line_str.startswith('data: '):
        data_str = line_str[6:].strip()
        
        if data_str == '[DONE]':
            # Отправка финального сообщения
            break
        
        # Парсинг JSON
        try:
            chunk_data = json.loads(data_str)
            # Обработка данных...
        except json.JSONDecodeError:
            continue  # Пропускаем некорректные JSON
```

## Тестирование

После исправления проверить:

1. **Длинные ответы (>1000 токенов)** - основная проблема
   - Запросить ответ на вопрос, требующий длинного ответа
   - Убедиться что ошибка ERR_HTTP2_PROTOCOL_ERROR Далее не возникает

2. **Очень длинные ответы (>5000 токенов)** - для проверки keep-alive
   - Запросить очень длинный ответ
   - Проверить что соединение стабильно и не прерывается

3. **Обработку ошибок от OpenRouter**
   - Убедиться что ошибки от OpenRouter корректно обрабатываются
   - Проверить что клиент получает понятные сообщения об ошибках

4. **Стабильность соединения**
   - Убедиться что при длинных запросах нет ERR_HTTP2_PROTOCOL_ERROR
   - Проверить что все токены доставляются клиенту

## Ожидаемый результат

- ✅ Длинные ответы (>1000 токенов) обрабатываются без ошибок
- ✅ Соединение остается стабильным при паузах между токенами
- ✅ Keep-alive комментарии предотвращают таймауты прокси/CDN
- ✅ Клиент получает все токены без прерываний

## Оценка времени

- Реализация keep-alive: 30 минут
- Улучшение парсинга SSE: 20 минут
- Исправление обработки ошибок: 15 минут
- Настройка Gunicorn: 5 минут
- Тестирование: 30 минут

**Итого:** ~1.5-2 часа

## Заметки

- Проблема возникает только при длинных ответах, что подтверждает гипотезу о таймаутах
- Keep-alive комментарии - стандартный способ поддержания SSE соединений
- Gunicorn по умолчанию имеет таймаут 30 секунд, нужно увеличить для длинных запросов

